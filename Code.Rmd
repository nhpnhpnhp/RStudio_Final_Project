---
title: "Code"
output: html_document
date: "2025-05-14"
---


C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt;
Load c√°c th∆∞ vi·ªán

```{r}
# C√†i ƒë·∫∑t th∆∞ vi·ªán
install.packages("tidyverse")
install.packages("data.table")
install.packages("lubridate")
install.packages("corrplot")
install.packages("leaflet")
install.packages("maps")
install.packages("gridExtra")
install.packages("factoextra")
install.packages("plotly")
install.packages("caret")
install.packages("cluster")
install.packages("e1071")
install.packages("randomForest")
install.packages("forecast")
install.packages("deSolve")
install.packages("boot")
install.packages("knitr")

# X·ª≠ l√Ω d·ªØ li·ªáu
library(tidyverse)    # G·ªìm dplyr, ggplot2, readr, tidyr, tibble,...
library(data.table)   # X·ª≠ l√Ω nhanh d·ªØ li·ªáu l·ªõn
library(readr)        # ƒê·ªçc d·ªØ li·ªáu (c≈©ng n·∫±m trong tidyverse)
library(tibble)       # Khung d·ªØ li·ªáu n√¢ng cao (trong tidyverse)
library(dplyr)        # X·ª≠ l√Ω d·ªØ li·ªáu (c≈©ng n·∫±m trong tidyverse)

# X·ª≠ l√Ω ng√†y th√°ng
library(lubridate)
# Tr·ª±c quan h√≥a
library(ggplot2)      # Bi·ªÉu ƒë·ªì c∆° b·∫£n (trong tidyverse)
library(plotly)       # Bi·ªÉu ƒë·ªì t∆∞∆°ng t√°c
library(corrplot)     # Ma tr·∫≠n t∆∞∆°ng quan
library(leaflet)      # B·∫£n ƒë·ªì t∆∞∆°ng t√°c
library(maps)         # B·∫£n ƒë·ªì tƒ©nh
library(gridExtra)    # S·∫Øp x·∫øp nhi·ªÅu bi·ªÉu ƒë·ªì
library(factoextra)   # Tr·ª±c quan h√≥a PCA, clustering,...

# H·ªçc m√°y v√† th·ªëng k√™

library(caret)        # H·ªçc m√°y t·ªïng qu√°t
library(cluster)      # Ph√¢n c·ª•m (K-means, PAM, hier clustering,...)
library(e1071)        # SVM, Naive Bayes,...
library(randomForest) # R·ª´ng ng·∫´u nhi√™n
library(forecast)     # D·ª± b√°o chu·ªói th·ªùi gian
library(boot)         # Bootstrap
library(broom)        # Chuy·ªÉn model th√†nh data frame
library(deSolve)      # M√¥ h√¨nh SIR, h·ªá ph∆∞∆°ng tr√¨nh vi ph√¢n
# B√°o c√°o
library(knitr)        # Hi·ªÉn th·ªã b·∫£ng ƒë·∫πp trong b√°o c√°o
```

ƒê·ªçc d·ªØ li·ªáu & xem c·∫•u tr√∫c file
```{r}
covid_19_clean_complete<-read_csv('../data/covid_19_clean_complete.csv')
worldometer <- read_csv("../data/worldometer_data.csv")
data <- read.csv("../data/day_wise.csv")
str(worldometer)
str(covid_19_clean_complete)
# Xem c·∫•u tr√∫c d·ªØ li·ªáu
glimpse(covid_19_clean_complete)
# Ki·ªÉm tra c·∫•u tr√∫c d·ªØ li·ªáu
str(data)
str(worldometer)
```

Ti·ªÅn x·ª≠ l√Ω d·ªØ li·ªáu
```{r}
# Ki·ªÉm tra gi√° tr·ªã missing
sum(is.na(data))

# Ki·ªÉm tra gi√° tr·ªã thi·∫øu
missing_worldometer <- colSums(is.na(worldometer))
missing_covid_clean <- colSums(is.na(covid_19_clean_complete))

# Hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng b·∫£ng
kable(missing_worldometer, caption = "Gi√° tr·ªã thi·∫øu trong worldometer_data")
kable(missing_covid_clean, caption = "Gi√° tr·ªã thi·∫øu trong covid_19_clean_complete")

############################
# Chuy·ªÉn ƒë·ªïi c·ªôt Date sang ƒë·ªãnh d·∫°ng ng√†y th√°ng
data$Date <- as.Date(data$Date)

# S·∫Øp x·∫øp d·ªØ li·ªáu theo ng√†y (n·∫øu c·∫ßn)
data <- data[order(data$Date), ]

worldometer_model <- worldometer_scaled %>%
  select(TotalCases, TotalDeaths, Population, TotalTests, Continent)
str(worldometer_model)
# ƒê·∫£m b·∫£o c·ªôt s·ªë trong worldometer
worldometer <- worldometer %>%
  mutate(across(c(TotalCases, TotalDeaths, Population, TotalTests), as.numeric))

# X·ª≠ l√Ω d·ªØ li·ªáu thi·∫øu cho c·ªôt Province/State
covid_19_clean_complete <- covid_19_clean_complete %>% 
  mutate(`Province/State` = ifelse(is.na(`Province/State`), "Unknown", `Province/State`))
# Chuy·ªÉn ƒë·ªïi ki·ªÉu d·ªØ li·ªáu ng√†y th√°ng
covid_19_clean_complete<- covid_19_clean_complete %>% 
  mutate(Date = as.Date(Date))

#Chu·∫©n h√≥a c√°c c·ªôt s·ªë trong worldometer v·ªÅ trung b√¨nh 0 v√† ƒë·ªô l·ªách chu·∫©n 1.
preprocess_params <- preProcess(worldometer %>% select_if(is.numeric),
                               method = c("center", "scale"))
worldometer_scaled <- predict(preprocess_params, worldometer)
summary(worldometer_scaled %>% select(TotalCases, TotalDeaths, Population, TotalTests))

#M√£ h√≥a c·ªôt Continent trong worldometer (n·∫øu c√≥) th√†nh s·ªë.
worldometer_scaled <- worldometer_scaled %>%
  mutate(Continent = as.factor(Continent)) %>%
  mutate(Continent = as.numeric(Continent))
summary(worldometer_scaled$Continent)

# Ki·ªÉm tra NA
print("Gi√° tr·ªã thi·∫øu trong worldometer_model:")
kable(colSums(is.na(worldometer_model)), caption = "Gi√° tr·ªã thi·∫øu tr∆∞·ªõc m√¥ h√¨nh")

# ƒêi·ªÅn NA (n·∫øu c√≤n)
worldometer_model <- worldometer_model %>%
  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%
  mutate(Continent = ifelse(is.na(Continent), 
                            names(sort(table(Continent), decreasing = TRUE))[1], 
                            Continent))

# Ki·ªÉm tra l·∫°i
if (any(is.na(worldometer_model))) {
  stop("D·ªØ li·ªáu v·∫´n ch·ª©a NA. Vui l√≤ng ki·ªÉm tra l·∫°i.")
}

# X·ª≠ l√Ω d·ªØ li·ªáu thi·∫øu cho c·ªôt Province/State
covid_19_clean_complete <- covid_19_clean_complete %>% 
  mutate(`Province/State` = ifelse(is.na(`Province/State`), "Unknown", `Province/State`))

# Chuy·ªÉn ƒë·ªïi ki·ªÉu d·ªØ li·ªáu ng√†y th√°ng
covid_19_clean_complete <- covid_19_clean_complete %>% 
  mutate(Date = as.Date(Date))
```
```{r}
# day_wise
summary(data)
  # T√≠nh c√°c gi√° tr·ªã th·ªëng k√™ ch√≠nh

stats <- data %>%
  summarise(
    # S·ªë ca nhi·ªÖm
    mean_confirmed = mean(Confirmed, na.rm = TRUE),
    min_confirmed = min(Confirmed, na.rm = TRUE),
    max_confirmed = max(Confirmed, na.rm = TRUE),
    sd_confirmed = sd(Confirmed, na.rm = TRUE),
    
    # S·ªë ca t·ª≠ vong
    mean_deaths = mean(Deaths, na.rm = TRUE),
    min_deaths = min(Deaths, na.rm = TRUE),
    max_deaths = max(Deaths, na.rm = TRUE),
    sd_deaths = sd(Deaths, na.rm = TRUE),
    
    # S·ªë ca h·ªìi ph·ª•c
    mean_recovered = mean(Recovered, na.rm = TRUE),
    min_recovered = min(Recovered, na.rm = TRUE),
    max_recovered = max(Recovered, na.rm = TRUE),
    sd_recovered = sd(Recovered, na.rm = TRUE),
    
    # S·ªë ca ƒëang ƒëi·ªÅu tr·ªã
    mean_active = mean(Active, na.rm = TRUE),
    min_active = min(Active, na.rm = TRUE),
    max_active = max(Active, na.rm = TRUE),
    sd_active = sd(Active, na.rm = TRUE),
    
    # S·ªë qu·ªëc gia
    mean_countries = mean(No..of.countries, na.rm = TRUE),
    min_countries = min(No..of.countries, na.rm = TRUE),
    max_countries = max(No..of.countries, na.rm = TRUE),
    
    # T·ª∑ l·ªá t·ª≠ vong/h·ªìi ph·ª•c
    mean_death_rate = mean(Deaths...100.Cases, na.rm = TRUE),
    mean_recovery_rate = mean(Recovered...100.Cases, na.rm = TRUE)
  )

  # T·∫°o b·∫£ng summary
summary_table <- data.frame(
  Bi·∫øn = names(data),
  Min = sapply(data, min, na.rm = TRUE),
  Max = sapply(data, max, na.rm = TRUE),
  Trung_b√¨nh = sapply(data, mean, na.rm = TRUE),
  ƒê·ªô_l·ªách_chu·∫©n = sapply(data, sd, na.rm = TRUE)
)
  # Hi·ªÉn th·ªã k·∫øt qu·∫£
print("C√°c th·ªëng k√™ ch√≠nh:")
print(stats)
print("B·∫£ng summary:")
print(summary_table)

  # Kho·∫£ng th·ªùi gian d·ªØ li·ªáu
date_range <- range(as.Date(data$Date))
print(paste("D·ªØ li·ªáu t·ª´", date_range[1], "ƒë·∫øn", date_range[2]))

# worldometer_data

# ƒê·ªçc d·ªØ li·ªáu


# Hi·ªÉn th·ªã t·ªïng quan d·ªØ li·ªáu
summary(worldometer)

# T√≠nh c√°c gi√° tr·ªã th·ªëng k√™ ch√≠nh
library(dplyr)

stats <- worldometer %>%
  summarise(
    # S·ªë qu·ªëc gia
    num_countries = n(),
    
    # D√¢n s·ªë
    mean_population = mean(Population, na.rm = TRUE),
    min_population = min(Population, na.rm = TRUE),
    max_population = max(Population, na.rm = TRUE),
    sd_population = sd(Population, na.rm = TRUE),
    
    # T·ªïng s·ªë ca nhi·ªÖm
    mean_total_cases = mean(TotalCases, na.rm = TRUE),
    min_total_cases = min(TotalCases, na.rm = TRUE),
    max_total_cases = max(TotalCases, na.rm = TRUE),
    sd_total_cases = sd(TotalCases, na.rm = TRUE),
    
    # T·ªïng s·ªë ca t·ª≠ vong
    mean_total_deaths = mean(TotalDeaths, na.rm = TRUE),
    min_total_deaths = min(TotalDeaths, na.rm = TRUE),
    max_total_deaths = max(TotalDeaths, na.rm = TRUE),
    sd_total_deaths = sd(TotalDeaths, na.rm = TRUE),
    
    # T·ªïng s·ªë ca h·ªìi ph·ª•c
    mean_total_recovered = mean(TotalRecovered, na.rm = TRUE),
    min_total_recovered = min(TotalRecovered, na.rm = TRUE),
    max_total_recovered = max(TotalRecovered, na.rm = TRUE),
    sd_total_recovered = sd(TotalRecovered, na.rm = TRUE),
    
    # S·ªë ca ƒëang ƒëi·ªÅu tr·ªã
    mean_active_cases = mean(ActiveCases, na.rm = TRUE),
    min_active_cases = min(ActiveCases, na.rm = TRUE),
    max_active_cases = max(ActiveCases, na.rm = TRUE),
    sd_active_cases = sd(ActiveCases, na.rm = TRUE),
    
    # T·ªïng s·ªë x√©t nghi·ªám
    mean_total_tests = mean(TotalTests, na.rm = TRUE),
    min_total_tests = min(TotalTests, na.rm = TRUE),
    max_total_tests = max(TotalTests, na.rm = TRUE),
    sd_total_tests = sd(TotalTests, na.rm = TRUE)
  )


# T·∫°o b·∫£ng summary
summary_table <- data.frame(
  Bi·∫øn = names(worldometer),
  Min = sapply(worldometer, function(x) ifelse(is.numeric(x), min(x, na.rm = TRUE), NA)),
  Max = sapply(worldometer, function(x) ifelse(is.numeric(x), max(x, na.rm = TRUE), NA)),
  Trung_b√¨nh = sapply(worldometer, function(x) ifelse(is.numeric(x), mean(x, na.rm = TRUE), NA)),
  ƒê·ªô_l·ªách_chu·∫©n = sapply(worldometer, function(x) ifelse(is.numeric(x), sd(x, na.rm = TRUE), NA))
  
)

# Hi·ªÉn th·ªã k·∫øt qu·∫£
print("C√°c th·ªëng k√™ ch√≠nh:")
print(stats)



print("B·∫£ng summary:")
print(summary_table)

# Ph√¢n ph·ªëi theo ch√¢u l·ª•c
continent_dist <- table(data$Continent)
print("Ph√¢n ph·ªëi s·ªë qu·ªëc gia theo ch√¢u l·ª•c:")
print(continent_dist)


# Covid_19_clean_complete

# Hi·ªÉn th·ªã t·ªïng quan d·ªØ li·ªáu
summary(covid_19_clean_complete)

# Load th∆∞ vi·ªán
library(dplyr)
library(lubridate)

# Th·ªëng k√™ m√¥ t·∫£
stats <- covid_19_clean_complete %>%
  summarise(
    mean_confirmed1 = mean(Confirmed, na.rm = TRUE),
    min_confirmed1 = min(Confirmed, na.rm = TRUE),
    max_confirmed1 = max(Confirmed, na.rm = TRUE),
    sd_confirmed1 = sd(Confirmed, na.rm = TRUE),
    
    mean_deaths1 = mean(Deaths, na.rm = TRUE),
    min_deaths1 = min(Deaths, na.rm = TRUE),
    max_deaths1 = max(Deaths, na.rm = TRUE),
    sd_deaths1 = sd(Deaths, na.rm = TRUE),
    
    mean_recovered1 = mean(Recovered, na.rm = TRUE),
    min_recovered1 = min(Recovered, na.rm = TRUE),
    max_recovered1 = max(Recovered, na.rm = TRUE),
    sd_recovered1 = sd(Recovered, na.rm = TRUE)
  )

print("C√°c th·ªëng k√™ ch√≠nh:")
print(stats)



# T·∫°o b·∫£ng summary m√¥ t·∫£
summary_table <- data.frame(
  Bi·∫øn = names(covid_19_clean_complete),
  Min = sapply(covid_19_clean_complete, function(x) ifelse(is.numeric(x), min(x, na.rm = TRUE), NA)),
  Max = sapply(covid_19_clean_complete, function(x) ifelse(is.numeric(x), max(x, na.rm = TRUE), NA)),
  Trung_b√¨nh = sapply(covid_19_clean_complete, function(x) ifelse(is.numeric(x), mean(x, na.rm = TRUE), NA)),
  ƒê·ªô_l·ªách_chu·∫©n = sapply(covid_19_clean_complete, function(x) ifelse(is.numeric(x), sd(x, na.rm = TRUE), NA))
  
)

print("B·∫£ng summary:")
print(summary_table)

# Ph√¢n ph·ªëi theo qu·ªëc gia (n·∫øu c√≥ bi·∫øn 'WHO.Region' hay 'Continent' th√¨ thay b·∫±ng ƒë√≥)
country_dist <- table(data$Country.Region)
print("S·ªë d√≤ng d·ªØ li·ªáu theo qu·ªëc gia:")
print(head(country_dist))
```

Ch·ª©c nƒÉng 1: Ph√¢n t√≠ch

1.1 Ph√¢n t√≠ch t·ªïng quan t·ªïng s·ªë ca nhi·ªÖm, t·ª≠ vong v√† h·ªìi ph·ª•c theo th·ªùi gian
```{r}
# T·ªïng s·ªë ca nhi·ªÖm, t·ª≠ vong v√† h·ªìi ph·ª•c theo th·ªùi gian
daily_summary <- covid_19_clean_complete %>% 
  group_by(Date) %>% 
  summarise(
    Total_Confirmed = sum(Confirmed, na.rm = TRUE),
    Total_Deaths = sum(Deaths, na.rm = TRUE),
    Total_Recovered = sum(Recovered, na.rm = TRUE),
    Total_Active = sum(Active, na.rm = TRUE)
  )
# Hi·ªÉn th·ªã bi·ªÉu ƒë·ªì t·ªïng quan
ggplot(daily_summary, aes(x = Date)) +
  geom_line(aes(y = Total_Confirmed, color = "Confirmed"), size = 1) +
  geom_line(aes(y = Total_Deaths, color = "Deaths"), size = 1) +
  geom_line(aes(y = Total_Recovered, color = "Recovered"), size = 1) +
  scale_color_manual(values = c("Confirmed" = "orange", "Deaths" = "red", "Recovered" = "green")) +
  labs(title = "COVID-19 Cases Over Time", 
       x = "Date", 
       y = "Number of Cases", 
       color = "Case Type") +
  theme_minimal()
```
  1.2. Ph√¢n t√≠ch theo qu·ªëc gia/khu v·ª±c
```{r}
# Top 10 qu·ªëc gia b·ªã ·∫£nh h∆∞·ªüng n·∫∑ng nh·∫•t
top_countries <- covid_19_clean_complete %>% 
  group_by(`Country/Region`) %>% 
  summarise(
    Total_Confirmed = sum(Confirmed, na.rm = TRUE),
    Total_Deaths = sum(Deaths, na.rm = TRUE),
    Total_Recovered = sum(Recovered, na.rm = TRUE)
  ) %>% 
  arrange(desc(Total_Confirmed)) %>% 
  head(10)
top_countries

# Bi·ªÉu ƒë·ªì c·ªôt cho top 10 qu·ªëc gia
ggplot(top_countries, aes(x = reorder(`Country/Region`, -Total_Confirmed), y = Total_Confirmed)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = Total_Confirmed), vjust = -0.5) +
  labs(title = "Top 10 Countries by Confirmed Cases", 
       x = "Country", 
       y = "Confirmed Cases") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# T·ª∑ l·ªá t·ª≠ vong theo qu·ªëc gia
country_stats <- covid_19_clean_complete %>% 
  group_by(`Country/Region`) %>% 
  summarise(
    Confirmed = sum(Confirmed, na.rm = TRUE),
    Deaths = sum(Deaths, na.rm = TRUE),
    Recovered = sum(Recovered, na.rm = TRUE),
    Mortality_Rate = ifelse(Confirmed > 0, Deaths/Confirmed * 100, 0)
  ) %>% 
  filter(Confirmed > 1000) %>% 
  arrange(desc(Mortality_Rate))

head(country_stats)
```
1.3.Ph√¢n t√≠ch theo khu v·ª±c WHO v·ªõi Mortality_Rate(t·ªâ l·ªá t·ª≠ vong)=(Deaths/Confirmed)x100
```{r}
# Ph√¢n t√≠ch theo khu v·ª±c WHO
who_region_stats <- covid_19_clean_complete %>% 
  group_by(`WHO Region`) %>% 
  summarise(
    Confirmed = sum(Confirmed, na.rm = TRUE),
    Deaths = sum(Deaths, na.rm = TRUE),
    Recovered = sum(Recovered, na.rm = TRUE),
    Mortality_Rate = ifelse(Confirmed > 0, Deaths/Confirmed * 100, 0)
  ) %>% 
  arrange(desc(Confirmed))
who_region_stats

# Bi·ªÉu ƒë·ªì tr√≤n cho ph√¢n b·ªë ca nhi·ªÖm theo khu v·ª±c
if (!exists("who_region_stats")) stop("who_region_stats kh√¥ng t·ªìn t·∫°i. Ki·ªÉm tra b∆∞·ªõc t·∫°o d·ªØ li·ªáu.")
plot_ly(who_region_stats, labels = ~`WHO Region`, values = ~Confirmed, type = 'pie') %>%
  layout(title_text = 'Distribution of COVID-19 Cases by WHO Region')
```

 
1.4.S·ª± t∆∞∆°ng quan gi·ªØa s·ªë ca t·ª≠ vong, s·ªë ca nhi·ªÖm v√† s·ªë ca h·ªìi ph·ª•c c·ªßa m·ªôt qu·ªëc gia (DF:Italy)
```{r}

selected_country <- "Italy"

# L·ªçc d·ªØ li·ªáu cho qu·ªëc gia ƒë√≥ v√† t·ªïng h·ª£p theo ng√†y
country_data <- covid_19_clean_complete %>%
  filter(`Country/Region` == selected_country) %>%
  group_by(Date) %>%
  summarise(
    Confirmed = sum(Confirmed, na.rm = TRUE),
    Deaths = sum(Deaths, na.rm = TRUE),
    Recovered = sum(Recovered, na.rm = TRUE)
  ) %>%
  filter(Confirmed > 0 & Recovered > 0)  # lo·∫°i b·ªè c√°c d√≤ng ch∆∞a c√≥ d·ªØ li·ªáu

# H·ªìi quy tuy·∫øn t√≠nh: D·ª± ƒëo√°n s·ªë ca t·ª≠ vong theo s·ªë ca nhi·ªÖm v√† h·ªìi ph·ª•c
lm_model <- lm(Deaths ~ Confirmed + Recovered, data = country_data)
model_summary <- summary(lm_model)

# In k·∫øt qu·∫£ m√¥ h√¨nh
print(model_summary)

# Tr√≠ch xu·∫•t c√°c th√¥ng tin
r_squared <- model_summary$r.squared
intercept <- coef(model_summary)[1]
confirmed_coef <- coef(model_summary)[2]
recovered_coef <- coef(model_summary)[3]
confirmed_p <- coef(summary(lm_model))["Confirmed", "Pr(>|t|)"]
recovered_p <- coef(summary(lm_model))["Recovered", "Pr(>|t|)"]

# Di·ªÖn gi·∫£i
cat("\n--- Di·ªÖn gi·∫£i m√¥ h√¨nh h·ªìi quy cho", selected_country, "---\n")
cat(sprintf("M√¥ h√¨nh gi·∫£i th√≠ch %.1f%% ph∆∞∆°ng sai c·ªßa s·ªë ca t·ª≠ vong (R¬≤ = %.2f).\n", 
            r_squared * 100, r_squared))

cat(sprintf("Khi s·ªë ca nhi·ªÖm tƒÉng th√™m 1, s·ªë ca t·ª≠ vong ∆∞·ªõc t√≠nh tƒÉng trung b√¨nh %.4f ca. ", confirmed_coef))
if (confirmed_p < 0.05) {
  cat("·∫¢nh h∆∞·ªüng c√≥ √Ω nghƒ©a th·ªëng k√™ (p < 0.05).\n")
} else {
  cat("·∫¢nh h∆∞·ªüng KH√îNG c√≥ √Ω nghƒ©a th·ªëng k√™ (p ‚â• 0.05).\n")
}

cat(sprintf("Khi s·ªë ca h·ªìi ph·ª•c tƒÉng th√™m 1, s·ªë ca t·ª≠ vong ∆∞·ªõc t√≠nh tƒÉng trung b√¨nh %.4f ca. ", recovered_coef))
if (recovered_p < 0.05) {
  cat("·∫¢nh h∆∞·ªüng c√≥ √Ω nghƒ©a th·ªëng k√™ (p < 0.05).\n")
} else {
  cat("·∫¢nh h∆∞·ªüng KH√îNG c√≥ √Ω nghƒ©a th·ªëng k√™ (p ‚â• 0.05).\n")
}

```

1.5 Ph√¢n t√≠ch t·ªâ l·ªá t·ª≠ vong t·∫°i c√°c khu v·ª±c y t·∫ø th·∫ø gi·ªõi

```{r}
anova_data <- covid_19_clean_complete %>%
  group_by(`Country/Region`, `WHO Region`) %>%
  summarise(
    Confirmed = sum(Confirmed),
    Deaths = sum(Deaths),
    .groups = "drop"
  ) %>%
  filter(Confirmed > 1000) %>%  # L·ªçc b·ªõt c√°c qu·ªëc gia c√≥ √≠t d·ªØ li·ªáu
  mutate(Mortality_Rate = Deaths / Confirmed * 100)

# Ki·ªÉm ƒë·ªãnh ANOVA
anova_model <- aov(Mortality_Rate ~ `WHO Region`, data = anova_data)
summary(anova_model)

remove_outliers <- function(data, column_name) {
  Q1 <- quantile(data[[column_name]], 0.25, na.rm = TRUE)
  Q3 <- quantile(data[[column_name]], 0.75, na.rm = TRUE)
  IQR_value <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR_value
  upper_bound <- Q3 + 1.5 * IQR_value

  # Ghi nh·∫≠n c√°c gi√° tr·ªã b·ªã lo·∫°i
  outliers <- data %>% filter(data[[column_name]] < lower_bound | data[[column_name]] > upper_bound)

  # Xo√° c√°c gi√° tr·ªã ngo·∫°i l·ªá
  cleaned_data <- data %>% filter(data[[column_name]] >= lower_bound & data[[column_name]] <= upper_bound)

  return(list(cleaned_data = cleaned_data, outliers = outliers))
}
# T√¨m v√† lo·∫°i b·ªè ngo·∫°i l·ªá trong c·ªôt Mortality_Rate
outlier_result <- remove_outliers(anova_data, "Mortality_Rate")

# D·ªØ li·ªáu sau khi lo·∫°i b·ªè
anova_clean <- outlier_result$cleaned_data

# D·ªØ li·ªáu ngo·∫°i l·ªá b·ªã lo·∫°i b·ªè (n·∫øu b·∫°n mu·ªën xem x√©t)
outlier_values <- outlier_result$outliers

# Ki·ªÉm tra k·∫øt qu·∫£
print(paste("S·ªë l∆∞·ª£ng ngo·∫°i l·ªá:", nrow(outlier_values)))
ggplot(anova_clean, aes(x = `WHO Region`, y = Mortality_Rate, fill = `WHO Region`)) +
  geom_violin(alpha = 0.6) +  # Violin Plot v·ªõi ƒë·ªô trong su·ªët 0.6
  geom_jitter(width = 0.2, alpha = 0.5, color = "black") +  # Jitter cho c√°c ƒëi·ªÉm
  labs(title = "Distribution of Mortality Rate by WHO Region",
       x = "WHO Region",
       y = "Mortality Rate (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  # T·∫Øt hi·ªÉn th·ªã legend
```
üîç C√°ch ƒë·ªçc bi·ªÉu ƒë·ªì Violin Plot:
1. Tr·ª•c ho√†nh (X-axis):
G·ªìm c√°c khu v·ª±c c·ªßa T·ªï ch·ª©c Y t·∫ø Th·∫ø gi·ªõi (WHO Region): Africa, Americas, Eastern Mediterranean, Europe, South-East Asia, Western Pacific.

2. Tr·ª•c tung (Y-axis):
Bi·ªÉu th·ªã t·ª∑ l·ªá t·ª≠ vong (%) = (Deaths / Confirmed) √ó 100 c·ªßa t·ª´ng qu·ªëc gia thu·ªôc m·ªói khu v·ª±c.

3. H√¨nh d√°ng "Violin":
H√¨nh d·∫°ng c·ªßa m·ªói violin bi·ªÉu th·ªã m·∫≠t ƒë·ªô ph√¢n ph·ªëi c·ªßa d·ªØ li·ªáu:

Ch·ªó ph√¨nh to: N∆°i c√≥ nhi·ªÅu qu·ªëc gia c√≥ t·ª∑ l·ªá t·ª≠ vong ·ªü m·ª©c ƒë√≥.

Ch·ªó h·∫πp l·∫°i: √çt qu·ªëc gia c√≥ t·ª∑ l·ªá t·ª≠ vong t·∫°i m·ª©c ƒë√≥.

4. C√°c ch·∫•m ƒëen (jitter):
M·ªói ch·∫•m l√† d·ªØ li·ªáu c·ªßa m·ªôt qu·ªëc gia. Ch√∫ng th·ªÉ hi·ªán c√°c gi√° tr·ªã th·ª±c t·∫ø.

Nh·ªù v·∫≠y b·∫°n c√≥ th·ªÉ v·ª´a th·∫•y ph√¢n b·ªë m·∫≠t ƒë·ªô, v·ª´a th·∫•y c√°c gi√° tr·ªã c·ª• th·ªÉ.

üìä Ph√¢n t√≠ch v√≠ d·ª• t·ª´ bi·ªÉu ƒë·ªì:
Africa: Ph√¢n ph·ªëi l·ªách ph·∫£i (right-skewed), nhi·ªÅu qu·ªëc gia c√≥ t·ª∑ l·ªá t·ª≠ vong th·∫•p (~1‚Äì2%), m·ªôt s·ªë qu·ªëc gia c√≥ gi√° tr·ªã cao h∆°n ~7‚Äì8%.

Europe: Tr·∫£i r·ªông h∆°n, c√≥ v·∫ª nh∆∞ t·ª∑ l·ªá t·ª≠ vong ph√¢n b·ªë t·ª´ kho·∫£ng 1% ƒë·∫øn h∆°n 7%, m·∫≠t ƒë·ªô d√†y h∆°n ·ªü kho·∫£ng gi·ªØa.

Western Pacific: Ph√¢n ph·ªëi kh√° h·∫πp, nhi·ªÅu qu·ªëc gia c√≥ t·ª∑ l·ªá t·ª≠ vong r·∫•t th·∫•p.

Eastern Mediterranean v√† Americas: T·ª∑ l·ªá t·ª≠ vong ƒëa d·∫°ng v√† c√≥ m·∫≠t ƒë·ªô ph√¢n ph·ªëi ƒë·ªÅu ·ªü nhi·ªÅu m·ª©c.

South-East Asia: C√≥ t·ª∑ l·ªá t·ª≠ vong nh√¨n chung kh√° th·∫•p.

‚úÖ 2. Di·ªÖn gi·∫£i k·∫øt qu·∫£ ki·ªÉm ƒë·ªãnh ANOVA
Sau khi ch·∫°y ANOVA b·∫±ng aov(Mortality_Rate ~ WHO Region, data = anova_data):

K·∫øt qu·∫£ b·∫°n s·∫Ω quan t√¢m:
p-value (Pr(>F)): ƒê√¢y l√† gi√° tr·ªã then ch·ªët ƒë·ªÉ ƒë√°nh gi√° s·ª± kh√°c bi·ªát.

Di·ªÖn gi·∫£i:
N·∫øu p-value < 0.05: C√≥ √Ω nghƒ©a th·ªëng k√™ ‚áí √≠t nh·∫•t m·ªôt khu v·ª±c c√≥ t·ª∑ l·ªá t·ª≠ vong trung b√¨nh kh√°c bi·ªát so v·ªõi ph·∫ßn c√≤n l·∫°i.

N·∫øu p-value ‚â• 0.05: Kh√¥ng c√≥ b·∫±ng ch·ª©ng ƒë·ªß m·∫°nh ƒë·ªÉ k·∫øt lu·∫≠n s·ª± kh√°c bi·ªát ƒë√°ng k·ªÉ.
- Ph√¢n t√≠ch xu h∆∞·ªõng s·ªë ca nhi·ªÖm to√†n c·∫ßu theo th·ªùi gian trong covid_clean



Ch·ª©c nƒÉng 2 : D·ª± ƒëo√°n
2.1 D·ª± ƒëo√°n S·ªë ca T·ª≠ vong theo ph∆∞∆°ng ph√°p h·ªìi quy
- D·ª± ƒëo√°n s·ªë ca t·ª≠ vong gi√∫p c√°c qu·ªëc gia chu·∫©n b·ªã gi∆∞·ªùng b·ªánh, m√°y th·ªü, v√† ngu·ªìn l·ª±c y t·∫ø.
```{r}
# 2. ƒê·∫∑t seed v√† chia d·ªØ li·ªáu
set.seed(123)
trainIndex <- createDataPartition(worldometer_model$TotalDeaths, p = 0.8, list = FALSE)
train_data <- worldometer_model[trainIndex, ]
test_data <- worldometer_model[-trainIndex, ]

# 3. Hu·∫•n luy·ªán m√¥ h√¨nh h·ªìi quy tuy·∫øn t√≠nh
model_lm <- train(
  TotalDeaths ~ .,  # Thay b·∫±ng c√¥ng th·ª©c ph√π h·ª£p n·∫øu c·∫ßn lo·∫°i bi·∫øn kh√¥ng mong mu·ªën
  data = train_data,
  method = "lm"
)

# 4. Th·ªëng k√™ k·∫øt qu·∫£ m√¥ h√¨nh
cat("M√¥ h√¨nh h·ªìi quy tuy·∫øn t√≠nh:\n")
cat("-----------------------------------------------------\n")
cat("1. R¬≤ (T·ª∑ l·ªá gi·∫£i th√≠ch bi·∫øn thi√™n c·ªßa m√¥ h√¨nh): ", summary(model_lm$finalModel)$r.squared, "\n")
cat("2. R¬≤ ƒëi·ªÅu ch·ªânh: ", summary(model_lm$finalModel)$adj.r.squared, "\n")

# 5. T√≥m t·∫Øt c√°c h·ªá s·ªë c·ªßa m√¥ h√¨nh v√† √Ω nghƒ©a th·ªëng k√™
model_summary <- tidy(model_lm$finalModel)
cat("3. C√°c h·ªá s·ªë c·ªßa m√¥ h√¨nh v√† √Ω nghƒ©a:\n")
for (i in 1:nrow(model_summary)) {
  coef_name <- model_summary$term[i]
  coef_value <- model_summary$estimate[i]
  std_error <- model_summary$std.error[i]
  t_value <- model_summary$statistic[i]
  p_value <- model_summary$p.value[i]
  
  cat(sprintf("- H·ªá s·ªë %s: %.3f (Std. Error: %.3f, t-value: %.3f, p-value: %.4f)\n", 
              coef_name, coef_value, std_error, t_value, p_value))
  
  if (p_value < 0.05) {
    cat("  => H·ªá s·ªë n√†y c√≥ √Ω nghƒ©a th·ªëng k√™ ·ªü m·ª©c alpha = 0.05.\n")
  } else {
    cat("  => H·ªá s·ªë n√†y kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™ ·ªü m·ª©c alpha = 0.05.\n")
  }
}

# 6. D·ª± ƒëo√°n tr√™n t·∫≠p test
predictions <- predict(model_lm, test_data)

# 7. ƒê√°nh gi√° m√¥ h√¨nh
results <- postResample(predictions, test_data$TotalDeaths)
cat("4. ƒê√°nh gi√° m√¥ h√¨nh:\n")
print(results)

# 8. V·∫Ω bi·ªÉu ƒë·ªì th·ª±c t·∫ø vs d·ª± ƒëo√°n
plot(test_data$TotalDeaths, predictions, 
     main = "Th·ª±c t·∫ø vs D·ª± ƒëo√°n",
     xlab = "T·ªïng s·ªë ca t·ª≠ vong th·ª±c t·∫ø", 
     ylab = "T·ªïng s·ªë ca t·ª≠ vong d·ª± ƒëo√°n",
     col = "black",  # M√†u ƒëi·ªÉm
     pch = 19,
     col.main = "black",
     col.lab = "black",
     col.axis = "black")
abline(0, 1, col = "red")
```

2.2 Ph√¢n lo·∫°i m·ª©c ƒë·ªô nghi√™m tr·ªçng gi√∫p x√°c ƒë·ªãnh c√°c qu·ªëc gia c·∫ßn h·ªó tr·ª£ y t·∫ø kh·∫©n c·∫•p.
```{r}
# T·∫°o bi·∫øn m·ª•c ti√™u
worldometer_model <- worldometer_model %>%
  mutate(Severity = as.factor(ifelse(TotalDeaths > median(TotalDeaths, na.rm = TRUE), "High", "Low")))

# Ki·ªÉm tra ph√¢n ph·ªëi l·ªõp
print("Ph√¢n ph·ªëi l·ªõp Severity:")
table(worldometer_model$Severity)

# Bi·∫øn ƒë·ªïi ƒë·∫∑c tr∆∞ng (gi·∫£m t√°ch bi·ªát)
worldometer_model <- worldometer_model %>%
  mutate(LogTotalCases = log1p(TotalCases))

# Chia d·ªØ li·ªáu train/test
set.seed(123)
trainIndex <- createDataPartition(worldometer_model$Severity, p = 0.8, list = FALSE)
train_data <- worldometer_model[trainIndex, ]
test_data <- worldometer_model[-trainIndex, ]

# M√¥ h√¨nh glmnet (c√≥ ƒëi·ªÅu chu·∫©n)
model_glm <- train(Severity ~ LogTotalCases + Population + TotalTests + Continent,
                   data = train_data,
                   method = "glmnet",
                   family = "binomial",
                   trControl = trainControl(method = "cv", number = 5, sampling = "up"))

# D·ª± ƒëo√°n v√† ƒë√°nh gi√°
predictions <- predict(model_glm, test_data)
print("Ma tr·∫≠n nh·∫ßm l·∫´n:")
confusionMatrix(predictions, test_data$Severity)

# L∆∞u bi·ªÉu ƒë·ªì ROC (n·∫øu c·∫ßn)
library(pROC)
roc_obj <- roc(test_data$Severity, as.numeric(predictions))
png("../outputs/plots/roc_curve.png")
plot(roc_obj, main = "ƒê∆∞·ªùng ROC cho m√¥ h√¨nh ph√¢n lo·∫°i")
dev.off()
```

2.3 Chu·ªói th·ªùi gian (Arinma)


```{r time_series_analysis}
# Ph√¢n t√≠ch chu·ªói th·ªùi gian v√† d·ª± ƒëo√°n ARIMA
print("Running chunk time_series_analysis")
# Ki·ªÉm tra g√≥i forecast v√† ggplot2
if (!require(forecast)) {
  install.packages("forecast")
  library(forecast)
}
if (!require(ggplot2)) {
  install.packages("ggplot2")
  library(ggplot2)
}

# Ki·ªÉm tra d·ªØ li·ªáu global_trend
if (!exists("global_trend")) {
  stop("global_trend kh√¥ng t·ªìn t·∫°i. Ch·∫°y chunk eda_time_series tr∆∞·ªõc.")
}
if (any(is.na(global_trend$TotalConfirmed))) {
  stop("D·ªØ li·ªáu TotalConfirmed ch·ª©a NA.")
}

# T·∫°o d·ªØ li·ªáu chu·ªói th·ªùi gian
ts_data <- ts(pmax(global_trend$TotalConfirmed, 0), frequency = 365)

# M√¥ h√¨nh ARIMA
model_arima <- auto.arima(ts_data, stepwise = TRUE, approximation = FALSE)

# D·ª± ƒëo√°n 30 ng√†y
forecast_arima <- forecast(model_arima, h = 30)

# 1. Bi·ªÉu ƒë·ªì d·ª± ƒëo√°n
forecast_df <- data.frame(
  Time = c(time(ts_data), time(forecast_arima$mean)),
  Cases = c(as.numeric(ts_data), as.numeric(forecast_arima$mean)),
  Lower = c(rep(NA, length(ts_data)), as.numeric(forecast_arima$lower[, 2])),
  Upper = c(rep(NA, length(ts_data)), as.numeric(forecast_arima$upper[, 2])),
  Type = c(rep("Th·ª±c t·∫ø", length(ts_data)), rep("D·ª± ƒëo√°n", length(forecast_arima$mean)))
)

p1 <- ggplot(forecast_df, aes(x = Time, y = Cases, color = Type)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), fill = "blue", alpha = 0.2, color = NA) +
  scale_color_manual(values = c("Th·ª±c t·∫ø" = "#333333", "D·ª± ƒëo√°n" = "#1E90FF")) +
  labs(title = "D·ª± ƒëo√°n S·ªë ca Nhi·ªÖm COVID-19 (ARIMA)",
       subtitle = "D·ªØ li·ªáu th·ª±c t·∫ø v√† d·ª± ƒëo√°n 30 ng√†y",
       x = "Th·ªùi gian (nƒÉm)", y = "T·ªïng s·ªë ca nhi·ªÖm") +
  theme_minimal(base_family = "Arial") +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12)
  )

ggsave("../outputs/plots/arima_forecast.png", p1, width = 10, height = 6, dpi = 300, bg = "white")

# 2. Bi·ªÉu ƒë·ªì residuals
residuals_df <- data.frame(
  Time = time(ts_data),
  Residuals = as.numeric(residuals(model_arima))
)

p2 <- ggplot(residuals_df, aes(x = Time, y = Residuals)) +
  geom_line(color = "#FF4500", linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#333333") +
  labs(title = "Residuals c·ªßa M√¥ h√¨nh ARIMA",
       subtitle = "Sai s·ªë gi·ªØa gi√° tr·ªã th·ª±c t·∫ø v√† d·ª± ƒëo√°n",
       x = "Th·ªùi gian (nƒÉm)", y = "Residuals") +
  theme_minimal(base_family = "Arial") +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12)
  )

ggsave("../outputs/plots/arima_residuals.png", p2, width = 10, height = 6, dpi = 300, bg = "white")

# 3. Bi·ªÉu ƒë·ªì ACF
acf_data <- acf(residuals(model_arima), plot = FALSE)
acf_df <- data.frame(
  Lag = acf_data$lag,
  ACF = acf_data$acf
)

p3 <- ggplot(acf_df, aes(x = Lag, y = ACF)) +
  geom_segment(aes(xend = Lag, yend = 0), color = "#1E90FF", linewidth = 1) +
  geom_hline(yintercept = 0, color = "#333333") +
  geom_hline(yintercept = c(-1.96/sqrt(length(ts_data)), 1.96/sqrt(length(ts_data))),
             linetype = "dashed", color = "#FF4500") +
  labs(title = "T·ª± t∆∞∆°ng quan (ACF) c·ªßa Residuals ARIMA",
       subtitle = "Ki·ªÉm tra t√≠nh ng·∫´u nhi√™n c·ªßa residuals",
       x = "ƒê·ªô tr·ªÖ (Lag)", y = "ACF") +
  theme_minimal(base_family = "Arial") +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12)
  )

ggsave("../outputs/plots/arima_acf.png", p3, width = 10, height = 6, dpi = 300, bg = "white")

# In t√≥m t·∫Øt m√¥ h√¨nh
print("T√≥m t·∫Øt m√¥ h√¨nh ARIMA:")
summary(model_arima)
```

2.4 Ph√¢n c·ª•m gi√∫p x√°c ƒë·ªãnh c√°c nh√≥m qu·ªëc gia c√≥ ƒë·∫∑c ƒëi·ªÉm d·ªãch b·ªánh t∆∞∆°ng t·ª± (v√≠ d·ª•: nh√≥m ki·ªÉm so√°t t·ªët nh∆∞ Vi·ªát Nam, nh√≥m b√πng ph√°t m·∫°nh nh∆∞ M·ªπ).
```{r}
# Ki·ªÉm tra NA
if (any(is.na(worldometer_model))) stop("D·ªØ li·ªáu ch·ª©a NA")

# Ch·ªçn ƒë·∫∑c tr∆∞ng s·ªë ƒë·ªÉ ph√¢n c·ª•m
cluster_data <- worldometer_model %>% 
  select(TotalCases, TotalDeaths, Population, TotalTests)

# X√°c ƒë·ªãnh s·ªë c·ª•m t·ªëi ∆∞u b·∫±ng ph∆∞∆°ng ph√°p Elbow (gi·ªØ nguy√™n code g·ªëc)
fviz_nbclust(cluster_data, kmeans, method = "wss") +
  labs(title = "Ph∆∞∆°ng ph√°p Elbow ƒë·ªÉ ch·ªçn s·ªë c·ª•m")

# L∆∞u v·ªõi n·ªÅn tr·∫Øng
ggsave("../outputs/plots/elbow_plot.png", bg = "white")

# Ph√¢n c·ª•m K-Means v·ªõi k=3 (gi·ªØ nguy√™n code g·ªëc)
set.seed(123)
kmeans_model <- kmeans(cluster_data, centers = 3, nstart = 25)
worldometer_model$Cluster <- as.factor(kmeans_model$cluster)

# Tr·ª±c quan h√≥a c·ª•m b·∫±ng PCA (gi·ªØ nguy√™n code g·ªëc)
pca_data <- prcomp(cluster_data, scale. = TRUE)
pca_plot <- fviz_pca_ind(pca_data, 
                         geom.ind = "point",
                         col.ind = worldometer_model$Cluster,
                         palette = "jco",
                         addEllipses = TRUE,
                         legend.title = "C·ª•m") +
  labs(title = "Ph√¢n c·ª•m qu·ªëc gia theo ƒë·∫∑c ƒëi·ªÉm d·ªãch b·ªánh (PCA)")

# L∆∞u v·ªõi n·ªÅn tr·∫Øng
ggsave("../outputs/plots/pca_clusters.png", pca_plot, bg = "white")

# T√≥m t·∫Øt s·ªë qu·ªëc gia m·ªói c·ª•m (gi·ªØ nguy√™n code g·ªëc)
print("S·ªë qu·ªëc gia trong m·ªói c·ª•m:")
table(worldometer_model$Cluster)
```
2.5. ƒê√°nh gi√° M√¥ h√¨nh
- X√°c ƒë·ªãnh m√¥ h√¨nh hi·ªáu qu·∫£ nh·∫•t ƒë·ªÉ d·ª± ƒëo√°n s·ªë ca t·ª≠ vong, ph√¢n lo·∫°i m·ª©c ƒë·ªô nghi√™m tr·ªçng, ho·∫∑c nh√≥m qu·ªëc gia.
- H·ªó tr·ª£ ∆∞u ti√™n ngu·ªìn l·ª±c y t·∫ø cho c√°c qu·ªëc gia c√≥ d·ªãch b·ªánh nghi√™m tr·ªçng (nh∆∞ M·ªπ, ·∫§n ƒê·ªô).
```{r}
# Ki·ªÉm tra NA trong d·ªØ li·ªáu
if (any(is.na(worldometer_model))) stop("D·ªØ li·ªáu ch·ª©a NA. Vui l√≤ng ki·ªÉm tra l·∫°i.")

# --- H·ªìi quy: RMSE, R¬≤ ---
results_lm <- postResample(predict(model_lm, test_data), test_data$TotalDeaths)
rmse_lm <- results_lm["RMSE"]
rsquared_lm <- results_lm["Rsquared"]
print("Hi·ªáu su·∫•t h·ªìi quy tuy·∫øn t√≠nh:")
print(data.frame(Metric = c("RMSE", "R¬≤"), Value = c(rmse_lm, rsquared_lm)))

# --- Ph√¢n lo·∫°i: Accuracy, F1-Score, ROC ---
conf_matrix <- confusionMatrix(predict(model_glm, test_data), test_data$Severity)
accuracy_glm <- conf_matrix$overall["Accuracy"]
f1_score <- conf_matrix$byClass["F1"]
roc_obj <- roc(as.numeric(test_data$Severity), as.numeric(predict(model_glm, test_data, type = "prob")[,2]))
auc_glm <- auc(roc_obj)
print("Hi·ªáu su·∫•t ph√¢n lo·∫°i:")
print(data.frame(Metric = c("Accuracy", "F1-Score", "AUC"), Value = c(accuracy_glm, f1_score, auc_glm)))

# V·∫Ω ƒë∆∞·ªùng ROC v·ªõi n·ªÅn tr·∫Øng
roc_plot <- ggroc(roc_obj, color = "#1c61b6") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  labs(title = "ƒê∆∞·ªùng ROC cho M√¥ h√¨nh Ph√¢n lo·∫°i", 
       x = "T·ª∑ l·ªá D∆∞∆°ng t√≠nh Gi·∫£", 
       y = "T·ª∑ l·ªá D∆∞∆°ng t√≠nh Th·∫≠t") +
  annotate("text", x = 0.4, y = 0.1, label = paste("AUC =", round(auc_glm, 2))) +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "white"))
ggsave("../outputs/plots/roc_curve_updated.png", roc_plot, bg = "white")

# --- Ph√¢n c·ª•m: Silhouette Score ---
cluster_data <- worldometer_model %>% select(TotalCases, TotalDeaths, Population, TotalTests)
silhouette_score <- silhouette(kmeans_model$cluster, dist(cluster_data))
silhouette_avg <- mean(silhouette_score[, 3])
print("Hi·ªáu su·∫•t ph√¢n c·ª•m:")
print(data.frame(Metric = "Silhouette Score", Value = silhouette_avg))

# --- So s√°nh hi·ªáu su·∫•t ---
performance_summary <- data.frame(
  Model = c("H·ªìi quy Tuy·∫øn t√≠nh", "Ph√¢n lo·∫°i (Logistic)", "Ph√¢n c·ª•m (K-Means)"),
  Metric = c("RMSE", "Accuracy", "Silhouette Score"),
  Value = c(rmse_lm, accuracy_glm, silhouette_avg)
)

# B·∫£ng t√≥m t·∫Øt
kable(performance_summary, caption = "T√≥m t·∫Øt Hi·ªáu su·∫•t C√°c M√¥ h√¨nh")

# Bi·ªÉu ƒë·ªì so s√°nh v·ªõi n·ªÅn tr·∫Øng
perf_plot <- ggplot(performance_summary, aes(x = Model, y = Value, fill = Metric)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  labs(title = "So s√°nh Hi·ªáu su·∫•t C√°c M√¥ h√¨nh", 
       x = "M√¥ h√¨nh", 
       y = "Gi√° tr·ªã Ch·ªâ s·ªë") +
  scale_fill_manual(values = c("RMSE" = "#1c61b6", 
                              "Accuracy" = "#e41a1c", 
                              "Silhouette Score" = "#4daf4a")) +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"))
ggsave("../outputs/plots/performance_comparison.png", perf_plot, bg = "white")

# L∆∞u t√≥m t·∫Øt hi·ªáu su·∫•t
write_csv(performance_summary, "../outputs/performance_summary.csv")
```

Ch·ª©c nƒÉng 3: M√¥ h√¨nh h√≥a t·ªëc ƒë·ªô l√¢y nhi·ªÖm v√† h·ªìi ph·ª•c b·∫±ng m√¥ h√¨nh SIR (Susceptible ‚Äì Infectious ‚Äì Recovered)

M√¥ h√¨nh SIR chia d√¢n s·ªë th√†nh 3 nh√≥m:

S (Susceptible): Nh·ªØng ng∆∞·ªùi d·ªÖ nhi·ªÖm b·ªánh

I (Infectious): Nh·ªØng ng∆∞·ªùi ƒëang nhi·ªÖm b·ªánh v√† c√≥ kh·∫£ nƒÉng l√¢y lan

R (Recovered): Nh·ªØng ng∆∞·ªùi ƒë√£ h·ªìi ph·ª•c ho·∫∑c t·ª≠ vong (kh√¥ng c√≤n kh·∫£ nƒÉng l√¢y nhi·ªÖm)

C√°c ph∆∞∆°ng tr√¨nh vi ph√¢n c·ªßa m√¥ h√¨nh SIR:
dS/dt = -Œ≤SI

dI/dt = Œ≤SI - Œ≥I

dR/dt = Œ≥I

Trong ƒë√≥:

Œ≤: T·ªëc ƒë·ªô l√¢y nhi·ªÖm

Œ≥: T·ªëc ƒë·ªô h·ªìi ph·ª•c

3.1 So s√°nh s·ªë ca nhi·ªÖm th·ª±c t·∫ø v√† s·ªë ca nhi·ªÖm theo m√¥ h√¨nh.
```{r}
# Gi·∫£ s·ª≠ d√¢n s·ªë l√† 7.8 t·ª∑
N <- 7.8e9

# T√≠nh S, I, R
data$R <- data$Recovered + data$Deaths
data$I <- data$Active
data$S <- N - data$I - data$R

# Ch·ªçn kho·∫£ng th·ªùi gian ph√¢n t√≠ch
start_date <- as.Date("2020-01-22")
end_date <- as.Date("2020-07-27")
subset_data <- data[data$Date >= start_date & data$Date <= end_date, ]
# H√†m lo·∫°i b·ªè ngo·∫°i l·ªá
remove_outliers <- function(x, lower_q = 0.05, upper_q = 0.95) {
  # M·ª•c ƒë√≠ch: lo·∫°i b·ªè d·ªØ li·ªáu b·∫•t th∆∞·ªùng c√≥ th·ªÉ do l·ªói ghi nh·∫≠n (v√≠ d·ª•: s·ªë h·ªìi ph·ª•c = 0 ho·∫∑c tƒÉng ƒë·ªôt bi·∫øn)
  qnt <- quantile(x, probs = c(lower_q, upper_q), na.rm = TRUE)
  outliers <- which(x < qnt[1] | x > qnt[2])
  x[outliers] <- NA
  return(x)
}
# T√≠nh gamma theo t·ª´ng ng√†y (gamma_est), sau ƒë√≥ l·∫•y trung b√¨nh ƒë·ªÉ d√πng trong m√¥ h√¨nh SIR
subset_data$gamma_est <- subset_data$New.recovered / subset_data$Active
subset_data$gamma_est <- ifelse(subset_data$Active <= 0, NA, subset_data$gamma_est)
subset_data$gamma_est <- remove_outliers(subset_data$gamma_est)
gamma <- mean(subset_data$gamma_est, na.rm = TRUE)

# T√≠nh beta d·ª±a tr√™n gamma_est
subset_data$dI <- c(NA, diff(subset_data$I))
subset_data$beta_est <- (subset_data$dI + subset_data$gamma_est * subset_data$I) / (subset_data$S * subset_data$I)
subset_data$beta_est <- remove_outliers(subset_data$beta_est)
beta <- mean(subset_data$beta_est, na.rm = TRUE)


# Beta theo th·ªùi gian
ggplot(subset_data, aes(x = Date)) +
  geom_line(aes(y = beta_est), color = "red") +
  labs(title = "Bi·∫øn ƒë·ªông h·ªá s·ªë l√¢y nhi·ªÖm (Œ≤) theo th·ªùi gian",
       y = "Œ≤ (beta)", x = "Ng√†y") +
  theme_minimal()

# Gamma theo th·ªùi gian
ggplot(subset_data, aes(x = Date)) +
  geom_line(aes(y = gamma_est), color = "darkgreen") +
  labs(title = "Bi·∫øn ƒë·ªông h·ªá s·ªë h·ªìi ph·ª•c (Œ≥) theo th·ªùi gian",
       y = "Œ≥ (gamma)", x = "Ng√†y") +
  theme_minimal()


sir_model <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    dS <- -beta * S * I
    dI <- beta * S * I - gamma * I
    dR <- gamma * I
    return(list(c(dS, dI, dR)))
  })
}

# Gi√° tr·ªã ban ƒë·∫ßu
init <- c(S = subset_data$S[1], I = subset_data$I[1], R = subset_data$R[1])
parameters <- c(beta = beta, gamma = gamma)
times <- 1:nrow(subset_data)

# M√¥ ph·ªèng
out <- ode(y = init, times = times, func = sir_model, parms = parameters)
out <- as.data.frame(out)

library(ggplot2)

ggplot() +
  geom_line(data = out, aes(x = time, y = I, color = "M√¥ h√¨nh")) +
  geom_line(data = subset_data, aes(x = 1:nrow(subset_data), y = I, color = "Th·ª±c t·∫ø")) +
  labs(title = "So s√°nh s·ªë ca nhi·ªÖm (I): m√¥ h√¨nh vs th·ª±c t·∫ø", x = "Ng√†y", y = "S·ªë ca") +
  scale_color_manual(values = c("M√¥ h√¨nh" = "red", "Th·ª±c t·∫ø" = "blue")) +
  theme_minimal()
```
3. T√≠nh to√°n c√°c ch·ªâ s·ªë theo y√™u c·∫ßu
T√≠nh t·ªëc ƒë·ªô h·ªìi ph·ª•c trong kho·∫£ng th·ªùi gian

```{r}
calculate_recovery_rate <- function(data, start_date, end_date) {
  subset <- data[data$Date >= as.Date(start_date) & data$Date <= as.Date(end_date), ]
  ratio <- subset$New.recovered / subset$Active
  ratio <- remove_outliers(ratio)
  mean(ratio, na.rm = TRUE)
}

recovery_rate <- calculate_recovery_rate(data, "2020-01-22", "2020-03-22")
cat("T·ªëc ƒë·ªô h·ªìi ph·ª•c trung b√¨nh:", recovery_rate, "\n")
```



3.2 T√≠nh t·ªëc ƒë·ªô thay ƒë·ªïi s·ªë ca nhi·ªÖm trong kho·∫£ng th·ªùi gian

```{r}
calculate_infection_change_rate <- function(data, start_date, end_date) {
  subset <- data[data$Date >= as.Date(start_date) & data$Date <= as.Date(end_date), ]
  total_new_cases <- sum(subset$New.cases)
  avg_active <- mean(subset$Active)
  avg_susceptible <- mean(N - subset$Active - subset$Recovered - subset$Deaths)
  duration <- as.numeric(as.Date(end_date) - as.Date(start_date))
  beta_est <- total_new_cases / (avg_active * avg_susceptible * duration)
  return(beta_est)
}

infection_rate <- calculate_infection_change_rate(data, "2020-01-22", "2020-07-27")
cat("T·ªëc ƒë·ªô thay ƒë·ªïi s·ªë ca nhi·ªÖm (beta ∆∞·ªõc l∆∞·ª£ng):", infection_rate, "\n")

```
3.4. Ph√¢n t√≠ch v√† tr·ª±c quan h√≥a d·ªØ li·ªáu
Ph√¢n t√≠ch c√°c t·ª∑ l·ªá
```{r}
mean_death_rate <- mean(data$Deaths / data$Confirmed * 100, na.rm = TRUE)
mean_recovery_rate <- mean(data$Recovered / data$Confirmed * 100, na.rm = TRUE)
mean_death_per_recovered <- mean(data$Deaths / data$Recovered * 100, na.rm = TRUE)

cat("T·ª∑ l·ªá t·ª≠ vong trung b√¨nh:", mean_death_rate, "%\n")
cat("T·ª∑ l·ªá h·ªìi ph·ª•c trung b√¨nh:", mean_recovery_rate, "%\n")
cat("T·ª∑ l·ªá t·ª≠ vong tr√™n h·ªìi ph·ª•c:", mean_death_per_recovered, "%\n")


```


3.5. Tr·ª±c quan h√≥a d·ªØ li·ªáu
```{r}
library(ggplot2)

# Bi·ªÉu ƒë·ªì s·ªë ca m·ªõi theo ng√†y
ggplot(data, aes(x = Date, y = New.cases)) +
  geom_line(color = "blue") +
  labs(title = "S·ªë ca m·ªõi m·ªói ng√†y", x = "Ng√†y", y = "Ca m·ªõi") +
  theme_minimal()

```
3.6 Ki·ªÉm ƒë·ªãnh kho·∫£ng ∆∞·ªõc l∆∞·ª£ng
```{r}

boot_fn <- function(data, indices) {
  d <- data[indices, ]
  recov <- d$New.recovered / d$Active
  recov <- remove_outliers(recov)
  gamma <- mean(recov, na.rm = TRUE)
  
  d$dI <- c(NA, diff(d$I))
  beta_est <- (d$dI + gamma * d$I) / (d$S * d$I)
  beta_est <- remove_outliers(beta_est)
  beta <- mean(beta_est, na.rm = TRUE)
  
  return(c(beta = beta, gamma = gamma))
}

boot_results <- boot(data = subset_data, statistic = boot_fn, R = 1000)

boot_results
boot.ci(boot_results, type = "perc", index = 1)  # CI cho beta
boot.ci(boot_results, type = "perc", index = 2)  # CI cho gamma
```



